<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔物獵人荒野配裝器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }
        .skill-card {
            transition: all 0.3s ease;
        }
        .skill-card:hover {
            transform: translateY(-2px);
        }
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
        }
    </style>
</head>
<body class="text-white p-4 md:p-6">
    <div id="app" class="loading">
        <div class="text-2xl mb-4">載入遊戲資料中...</div>
        <div class="text-sm text-slate-400">Loading game data...</div>
    </div>

    <script>
        // 全域資料變數
        let SKILLS = [];
        let ARMOR_DATA = { low_rank: {}, high_rank: {} };
        let DECORATIONS = [];
        
        // 狀態管理
        let selectedSkills = {};
        let searchTerm = '';
        let currentRank = 'high_rank'; // 預設使用上位防具

        // 載入所有資料
        async function loadGameData() {
            try {
                // 載入技能資料
                const skillsResponse = await fetch('data/skills.json');
                if (skillsResponse.ok) {
                    const skillsData = await skillsResponse.json();
                    SKILLS = [...(skillsData.armor_skills || []), ...(skillsData.weapon_skills || [])];
                    console.log(`✓ 已載入 ${SKILLS.length} 個技能`);
                } else {
                    throw new Error('無法載入技能資料');
                }

                // 載入防具資料
                const armorsResponse = await fetch('data/armors.json');
                if (armorsResponse.ok) {
                    ARMOR_DATA = await armorsResponse.json();
                    console.log(`✓ 已載入防具資料`);
                } else {
                    throw new Error('無法載入防具資料');
                }

                // 載入裝飾珠資料（可選）
                try {
                    const decorationsResponse = await fetch('data/decorations.json');
                    if (decorationsResponse.ok) {
                        const decorationsData = await decorationsResponse.json();
                        DECORATIONS = decorationsData.decorations || [];
                        console.log(`✓ 已載入 ${DECORATIONS.length} 個裝飾珠`);
                    }
                } catch (e) {
                    console.log('未找到裝飾珠資料，跳過');
                }

                // 資料載入完成，初始化應用
                initApp();
            } catch (error) {
                console.error('資料載入錯誤:', error);
                document.getElementById('app').innerHTML = `
                    <div class="max-w-2xl mx-auto text-center">
                        <h1 class="text-3xl font-bold text-red-400 mb-4">資料載入失敗</h1>
                        <p class="text-slate-300 mb-4">請確認以下事項：</p>
                        <ul class="text-left text-slate-400 space-y-2 mb-6">
                            <li>✓ 資料檔案是否存在於 <code class="bg-slate-700 px-2 py-1 rounded">data/</code> 目錄中</li>
                            <li>✓ 檔案名稱是否正確：skills.json, armors.json</li>
                            <li>✓ JSON 格式是否正確（可用 jsonlint.com 驗證）</li>
                            <li>✓ 如果在本地測試，需使用本地伺服器（不能直接開啟 HTML）</li>
                        </ul>
                        <div class="bg-slate-800 p-4 rounded text-left">
                            <div class="text-sm text-slate-500 mb-2">錯誤訊息：</div>
                            <code class="text-red-300">${error.message}</code>
                        </div>
                        <div class="mt-6">
                            <button onclick="location.reload()" class="px-6 py-2 bg-orange-500 rounded hover:bg-orange-600">
                                重新載入
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // 初始化應用程式
        function initApp() {
            const appContainer = document.getElementById('app');
            appContainer.className = '';
            appContainer.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <h1 class="text-3xl md:text-4xl font-bold mb-2 text-center bg-gradient-to-r from-orange-400 to-red-500 bg-clip-text text-transparent">
                        魔物獵人荒野配裝器
                    </h1>
                    <p class="text-center text-slate-400 mb-4">選擇想要的技能，系統會自動推薦最佳配裝組合</p>
                    
                    <!-- 資料統計 -->
                    <div class="text-center text-sm text-slate-500 mb-6">
                        共 ${SKILLS.length} 個技能 | 
                        上位防具 ${countArmors('high_rank')} 件 | 
                        下位防具 ${countArmors('low_rank')} 件
                        ${DECORATIONS.length > 0 ? ` | ${DECORATIONS.length} 個裝飾珠` : ''}
                    </div>

                    <div class="grid lg:grid-cols-2 gap-6">
                        <!-- 左側：技能選擇 -->
                        <div class="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-2xl font-bold flex items-center gap-2">
                                    <span class="text-orange-400">①</span> 選擇技能
                                </h2>
                                <!-- 切換防具階級 -->
                                <div class="flex gap-2">
                                    <button 
                                        id="btnLowRank"
                                        onclick="switchRank('low_rank')"
                                        class="px-3 py-1 text-sm rounded transition bg-slate-700 hover:bg-slate-600"
                                    >
                                        下位
                                    </button>
                                    <button 
                                        id="btnHighRank"
                                        onclick="switchRank('high_rank')"
                                        class="px-3 py-1 text-sm rounded transition bg-orange-500 text-white"
                                    >
                                        上位
                                    </button>
                                </div>
                            </div>
                            
                            <input
                                type="text"
                                id="searchInput"
                                placeholder="搜尋技能..."
                                class="w-full px-4 py-2 mb-4 bg-slate-900/50 border border-slate-600 rounded-lg focus:outline-none focus:border-orange-400 text-white"
                            />

                            <!-- 已選技能 -->
                            <div id="selectedSkills" class="mb-4 hidden p-4 bg-slate-900/50 rounded-lg border border-orange-500/30">
                                <div class="text-sm text-slate-400 mb-2">已選技能：</div>
                                <div id="selectedSkillsList" class="flex flex-wrap gap-2"></div>
                            </div>

                            <!-- 技能列表 -->
                            <div id="skillsList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                        </div>

                        <!-- 右側：配裝結果 -->
                        <div class="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700">
                            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                                <span class="text-orange-400">②</span> 推薦配裝
                            </h2>
                            <div id="resultsArea"></div>
                        </div>
                    </div>

                    <div class="mt-6 text-center text-sm text-slate-500">
                        <p>資料來源：遊戲內資料整理 | 最後更新：${new Date().toLocaleDateString('zh-TW')}</p>
                    </div>
                </div>
            `;

            // 綁定事件
            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchTerm = e.target.value.toLowerCase();
                renderSkills();
            });

            // 初始渲染
            renderSkills();
            showInitialMessage();
        }

        // 計算防具數量
        function countArmors(rank) {
            if (!ARMOR_DATA[rank]) return 0;
            const parts = ['head', 'chest', 'arms', 'waist', 'legs'];
            return parts.reduce((sum, part) => {
                return sum + (ARMOR_DATA[rank][part]?.length || 0);
            }, 0);
        }

        // 切換防具階級
        function switchRank(rank) {
            currentRank = rank;
            
            // 更新按鈕樣式
            document.getElementById('btnLowRank').className = 
                rank === 'low_rank' 
                ? 'px-3 py-1 text-sm rounded transition bg-orange-500 text-white'
                : 'px-3 py-1 text-sm rounded transition bg-slate-700 hover:bg-slate-600';
            
            document.getElementById('btnHighRank').className = 
                rank === 'high_rank'
                ? 'px-3 py-1 text-sm rounded transition bg-orange-500 text-white'
                : 'px-3 py-1 text-sm rounded transition bg-slate-700 hover:bg-slate-600';
            
            // 重新計算配裝
            if (Object.keys(selectedSkills).length > 0) {
                showCalculateButton();
            }
        }

        // 渲染技能列表
        function renderSkills() {
            const filteredSkills = SKILLS.filter(skill =>
                skill.name.toLowerCase().includes(searchTerm) ||
                skill.description.toLowerCase().includes(searchTerm)
            );

            const skillsList = document.getElementById('skillsList');
            skillsList.innerHTML = filteredSkills.map(skill => `
                <div class="skill-card bg-slate-900/30 p-4 rounded-lg border border-slate-700 hover:border-slate-600">
                    <div class="flex justify-between items-start mb-1">
                        <div class="font-semibold">${skill.name}</div>
                        ${skill.name_en ? `<div class="text-xs text-slate-500">${skill.name_en}</div>` : ''}
                    </div>
                    <div class="text-sm text-slate-400 mb-3">${skill.description}</div>
                    <div class="flex gap-2 flex-wrap">
                        ${Array.from({length: skill.max_level}, (_, i) => {
                            const level = i + 1;
                            const isSelected = selectedSkills[skill.id] === level;
                            return `
                                <button
                                    onclick="toggleSkill('${skill.id}', ${level})"
                                    class="px-3 py-1 rounded transition ${
                                        isSelected
                                            ? 'bg-orange-500 text-white font-bold'
                                            : 'bg-slate-700 hover:bg-slate-600 text-slate-200'
                                    }"
                                    title="${skill.effects && skill.effects[level] ? skill.effects[level] : ''}"
                                >
                                    Lv${level}
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            renderSelectedSkills();
        }

        // 渲染已選技能
        function renderSelectedSkills() {
            const container = document.getElementById('selectedSkills');
            const list = document.getElementById('selectedSkillsList');
            
            if (Object.keys(selectedSkills).length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            list.innerHTML = Object.entries(selectedSkills).map(([skillId, level]) => {
                const skill = SKILLS.find(s => s.id === skillId);
                return `
                    <div class="flex items-center gap-2 bg-orange-500/20 px-3 py-1 rounded-full text-orange-200">
                        <span class="text-sm font-medium">${skill.name} Lv${level}</span>
                        <button onclick="removeSkill('${skillId}')" class="hover:text-red-400 text-lg leading-none font-bold">×</button>
                    </div>
                `;
            }).join('');
        }

        // 切換技能
        function toggleSkill(skillId, level) {
            if (selectedSkills[skillId] === level) {
                delete selectedSkills[skillId];
            } else {
                selectedSkills[skillId] = level;
            }
            renderSkills();
            if (Object.keys(selectedSkills).length > 0) {
                showCalculateButton();
            } else {
                showInitialMessage();
            }
        }

        // 移除技能
        function removeSkill(skillId) {
            delete selectedSkills[skillId];
            renderSkills();
            if (Object.keys(selectedSkills).length === 0) {
                showInitialMessage();
            } else {
                showCalculateButton();
            }
        }

        // 顯示初始訊息
        function showInitialMessage() {
            document.getElementById('resultsArea').innerHTML = `
                <div class="text-center py-20 text-slate-400">
                    <p class="text-lg">請先選擇想要的技能</p>
                    <p class="text-sm mt-2">系統會自動計算最佳配裝組合</p>
                </div>
            `;
        }

        // 顯示計算按鈕
        function showCalculateButton() {
            document.getElementById('resultsArea').innerHTML = `
                <div class="text-center py-20">
                    <button
                        onclick="calculateBuilds()"
                        class="px-8 py-3 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg font-bold hover:from-orange-600 hover:to-red-600 transition shadow-lg transform hover:scale-105"
                    >
                        開始計算配裝
                    </button>
                    <p class="text-sm text-slate-400 mt-4">已選擇 ${Object.keys(selectedSkills).length} 個技能</p>
                </div>
            `;
        }

        // 計算配裝
        function calculateBuilds() {
            const results = document.getElementById('resultsArea');
            results.innerHTML = '<div class="text-center py-20 text-slate-400 animate-pulse">計算中...</div>';

            setTimeout(() => {
                const builds = generateBuilds();
                renderBuilds(builds);
            }, 300);
        }

        // 生成配裝
        function generateBuilds() {
            const allBuilds = [];
            const rankData = ARMOR_DATA[currentRank];
            
            if (!rankData) {
                console.error('找不到對應階級的防具資料');
                return [];
            }

            const heads = rankData.head || [];
            const chests = rankData.chest || [];
            const arms = rankData.arms || [];
            const waists = rankData.waist || [];
            const legs = rankData.legs || [];

            heads.forEach(head => {
                chests.forEach(chest => {
                    arms.forEach(arm => {
                        waists.forEach(waist => {
                            legs.forEach(leg => {
                                const build = { head, chest, arms: arm, waist, legs: leg };
                                const skills = calculateBuildSkills(build);
                                const score = scoreBuild(skills);
                                const defense = head.defense + chest.defense + arm.defense + waist.defense + leg.defense;
                                allBuilds.push({ ...build, skills, score, defense });
                            });
                        });
                    });
                });
            });

            return allBuilds.sort((a, b) => b.score - a.score).slice(0, 10);
        }

        // 計算技能
        function calculateBuildSkills(build) {
            const totalSkills = {};
            ['head', 'chest', 'arms', 'waist', 'legs'].forEach(part => {
                const armor = build[part];
                if (armor && armor.skills) {
                    Object.entries(armor.skills).forEach(([skill, level]) => {
                        totalSkills[skill] = (totalSkills[skill] || 0) + level;
                    });
                }
            });
            return totalSkills;
        }

        // 評分
        function scoreBuild(buildSkills) {
            let score = 0;
            Object.entries(selectedSkills).forEach(([skillId, desiredLevel]) => {
                const actualLevel = buildSkills[skillId] || 0;
                if (actualLevel >= desiredLevel) {
                    score += desiredLevel * 10;
                } else {
                    score += actualLevel * 5;
                }
            });
            return score;
        }

        // 渲染配裝結果
        function renderBuilds(builds) {
            const results = document.getElementById('resultsArea');
            
            if (builds.length === 0) {
                results.innerHTML = `
                    <div class="text-center py-20 text-slate-400">
                        <p class="text-lg">找不到符合的配裝</p>
                        <p class="text-sm mt-2">請嘗試降低技能等級或選擇較少技能</p>
                    </div>
                `;
                return;
            }

            results.innerHTML = `
                <div class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                    ${builds.map((build, idx) => `
                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-600 hover:border-slate-500 transition">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-bold text-lg">配裝方案 #${idx + 1}</span>
                                <div class="flex gap-2">
                                    <span class="text-xs bg-blue-500/20 text-blue-300 px-2 py-1 rounded">
                                        防禦: ${build.defense}
                                    </span>
                                    <span class="text-xs bg-orange-500/20 text-orange-300 px-2 py-1 rounded">
                                        評分: ${build.score}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="space-y-1.5 mb-3 text-sm">
                                ${['head', 'chest', 'arms', 'waist', 'legs'].map(part => {
                                    const partNames = {
                                        head: '頭部',
                                        chest: '胸部',
                                        arms: '手部',
                                        waist: '腰部',
                                        legs: '腳部'
                                    };
                                    return `
                                        <div class="flex items-center gap-2">
                                            <span class="text-slate-400 w-12">${partNames[part]}:</span>
                                            <span class="font-medium text-slate-200">${build[part].name}</span>
                                            <span class="text-xs text-slate-500">(防${build[part].defense})</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>

                            <div class="border-t border-slate-700 pt-3">
                                <div class="text-xs text-slate-400 mb-2">總技能:</div>
                                <div class="flex flex-wrap gap-1.5">
                                    ${Object.entries(build.skills)
                                        .sort((a, b) => {
                                            const aRequired = selectedSkills[a[0]];
                                            const bRequired = selectedSkills[b[0]];
                                            if (aRequired && !bRequired) return -1;
                                            if (!aRequired && bRequired) return 1;
                                            return 0;
                                        })
                                        .map(([skillId, level]) => {
                                            const skill = SKILLS.find(s => s.id === skillId);
                                            const isRequired = selectedSkills[skillId];
                                            const isFulfilled = isRequired && level >= selectedSkills[skillId];
                                            return `
                                                <div class="text-xs px-2 py-1 rounded ${
                                                    isFulfilled
                                                        ? 'bg-green-500/20 text-green-300 font-medium'
                                                        : isRequired
                                                        ? 'bg-yellow-500/20 text-yellow-300'
                                                        : 'bg-slate-700 text-slate-300'
                                                }">
                                                    ${skill?.name || skillId} Lv${level}
                                                    ${isFulfilled ? ' ✓' : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 啟動應用
        loadGameData();
    </script>
</body>
</html>
